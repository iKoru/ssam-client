(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0e9752"],{"8e2a":function(t,s,e){"use strict";e.r(s);var a=function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("v-container",[a("v-layout",{staticClass:"d-block",attrs:{row:"","justify-center":"","align-center":""}},[a("v-flex",{staticClass:"mx-auto",attrs:{xs12:"",sm10:"",lg8:"","px-3":t.$vuetify.breakpoint.xsOnly}},[a("v-layout",{attrs:{row:"",wrap:""}},[a("v-flex",{attrs:{xs12:""}},[a("h3",{staticClass:"headline"},[t._v("채팅 목록")])]),a("v-flex",{attrs:{xs12:""}},[a("v-data-table",{class:{"customAction mt-4":!0,noResult:0===t.totalChats},attrs:{xs12:"",items:t.chats,id:"chatTable","hide-headers":"","rows-per-page-items":[15],loading:t.loading,"total-items":t.totalChats,pagination:t.pagination},on:{"update:pagination":function(s){t.pagination=s}},scopedSlots:t._u([{key:"items",fn:function(s){return[a("tr",{staticClass:"cursor-pointer",on:{click:function(e){return t.getChat(s.item)}}},[a("td",{staticClass:"px-2"},[a("v-avatar",{attrs:{color:"T"!==s.item.chatType?null:"primary",title:s.item.otherNickName+"님과의 대화",size:"32px"}},["T"!==s.item.chatType?a("img",{attrs:{src:s.item.picturePath||e("53c0")}}):a("span",{staticClass:"white--text subheading"},[t._v(t._s("(알 수 없음)"===s.item.otherNickName?"?":s.item.otherNickName.substring(0,1)))])])],1),t.$vuetify.breakpoint.smAndUp?a("td",{staticClass:"text-xs-left px-1",attrs:{title:"T"===s.item.chatType?"토픽 닉네임":"라운지 필명"}},[t._v(t._s(s.item.otherNickName))]):t._e(),a("td",{staticClass:"text-xs-left multi-row px-2"},[t._v(t._s(t.getShortContents(s.item.lastContents)))]),a("td",{staticClass:"text-xs-right px-2"},[t._v(t._s(s.item.lastSendTimestamp.fromNow()))]),a("td",{staticClass:"px-2"},[a("v-btn",{staticClass:"short",attrs:{small:"",color:"error"},on:{click:function(e){return e.stopPropagation(),t.deleteChat(s.item)}}},[t._v("삭제")])],1)])]}}])},[a("template",{slot:"no-data"},[t._v(t._s(this.noresult))]),a("template",{slot:"actions-prepend"},[a("v-btn",{attrs:{color:"primary",loading:t.loading},on:{click:t.getChatList}},[t._v("새로고침")]),a("v-spacer")],1)],2)],1)],1)],1),a(t.$vuetify.breakpoint.xsOnly?"v-dialog":"div",{tag:"component",attrs:{"full-screen":""},model:{value:t.isChatOpen,callback:function(s){t.isChatOpen=s},expression:"isChatOpen"}},[a("beautiful-chat",{attrs:{participants:t.participants,onMessageWasSent:t.sendMessage,loadPreviousMessages:t.loadPreviousMessages,loadNewMessages:t.loadNewMessages,loading:t.loadingMessages,messageList:t.messageList,newMessagesCount:t.newMessagesCount,isOpen:t.isChatOpen,close:t.closeChat,open:t.openChat,placeholder:"대화 내용을 입력해주세요.",showEmoji:!1,"has-user-list":!1,showFile:!1,colors:t.colors,alwaysScrollToBottom:t.scrollToBottom,showLauncher:!1,messageStyling:!1,title:t.title,disabled:t.disabled}})],1)],1)],1)},i=[],o=e("713b");function n(t){for(var s=1;s<arguments.length;s++){var e=null!=arguments[s]?arguments[s]:{},a=Object.keys(e);"function"===typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(e).filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.forEach(function(s){h(t,s,e[s])})}return t}function h(t,s,e){return s in t?Object.defineProperty(t,s,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[s]=e,t}var r={name:"Message",data(){return{loading:!0,chats:[],totalChats:0,pagination:{},participants:[{id:"other",name:"other",imageUrl:""}],messageList:[],newMessagesCount:0,isChatOpen:!1,colors:{header:{bg:"#4e8cff",text:"#ffffff"},launcher:{bg:"#4e8cff"},messageList:{bg:"#ffffff"},sentMessage:{bg:"#4e8cff",text:"#ffffff"},receivedMessage:{bg:"#eaeaea",text:"#222222"},userInput:{bg:"#f4f7f9",text:"#565867"}},title:"",disabled:!1,chatId:null,noPreviousMessage:!1,scrollToBottom:!0,loadingMessages:!1}},computed:{noresult(){return this.loading?"내 채팅 목록을 불러오고 있습니다. 잠시만 기다려주세요...":"아직 개설된 채팅이 없습니다."}},created(){this.$emit("update:layout",o["a"]),this.$store.dispatch("setColumnType","HIDE_ALWAYS"),this.getChatList()},mounted(){this.$route.query.chatId&&(this.chats.some(t=>t.chatId===this.$route.query.chatId)?this.getChat(this.chats.find(t=>t.chatId===this.$route.query.chatId)):this.$axios.get("/message/target",{params:{chatId:this.$route.query.chatId},headers:{silent:!0}}).then(t=>{this.getChat(t.data)}).catch(t=>{this.$store.dispatch("showSnackbar",{text:`${t.response?t.response.data.message:"채팅을 찾지 못했습니다."}`,color:"error"})}))},methods:{getChatList(){this.loading=!0,this.$axios.get("/message/list",{params:{page:this.pagination.page},headers:{silent:!0}}).then(t=>{this.chats=t.data.map(t=>n({},t,{lastSendTimestamp:this.$moment(t.lastSendTimestamp,"YYYYMMDDHHmmss")})),this.totalChats=t.data.length>0?t.data[0].totalCount:0,this.loading=!1}).catch(t=>{console.log(t),this.$store.dispatch("showSnackbar",{text:`${t.response?t.response.data.message:"채팅 목록을 가져오지 못했습니다."}`,color:"error"}),this.loading=!1}),this.closeChat()},sendMessage(t){(t=>{if(t.data.text.trim().length>0){t.data.text=t.data.text.trim();const s=this.chats.find(t=>t.chatId===this.chatId),e=this.$moment(s.lastSendTimestamp).format("YMMDDHHmmss");this.$axios.post("/message",{chatId:this.chatId,contents:t.data.text,lastSendTimestamp:e},{headers:{silent:!0}}).then(t=>{Array.isArray(t.data.messageList)&&(t.data.messageList.reverse(),this.messageList=this.messageList.concat(t.data.messageList.filter(t=>t.sendTimestamp>e).map(t=>({author:t.isSender?"me":s?s.otherNickName:"(알 수 없음)",type:"text",data:{text:t.contents,meta:this.$moment(t.sendTimestamp,"YYYYMMDDHHmmss").format("Y.M.D hh:mm:ss a")}}))),t.data.messageList.length>0&&(s.lastSendTimestamp=this.$moment(t.data.messageList[t.data.messageList.length-1].sendTimestamp,"YYYYMMDDHHmmss"),s.lastContents=t.data.messageList[t.data.messageList.length-1].contents))}).catch(t=>{console.log(t.response),this.$store.dispatch("showSnackbar",{text:`${t.response?t.response.data.message:"메시지를 보내지 못했습니다."}`,color:"error"})})}})(t)},onMessageWasSent(t){this.messageList=[...this.messageList,t]},openChat(){this.isChatOpen=!0,this.newMessagesCount=0},closeChat(){this.isChatOpen=!1},getChat(t){this.disabled="DELETED"===t.otherStatus,this.axios.get("/message",{params:{chatId:t.chatId}}).then(s=>{this.messageList=s.data.map(s=>({author:s.isSender?"me":t.otherNickName,type:"text",data:{text:s.contents,meta:this.$moment(s.sendTimestamp,"YYYYMMDDHHmmss").format("Y.M.D hh:mm:ss a")}})),console.log(this.messageList,"messageList"),this.messageList.reverse(),this.disabled&&this.messageList.push({type:"system",data:{text:`${t.otherNickName} 님이 채팅을 나갔습니다.`}}),this.noPreviousMessage=this.messageList.length<15,this.participants=[{id:t.otherNickName,name:t.otherNickName,imageUrl:"T"===t.chatType?"":t.picturePath||e("53c0")}],this.chatId=t.chatId,this.isChatOpen=!0}).catch(t=>{console.log(t.response),this.$store.dispatch("showSnackbar",{text:t.response?t.response.data.message:"채팅을 불러오지 못했습니다.",color:"error"})}),this.title=t.otherNickName+"님과의 대화"},deleteChat(t){confirm("이 채팅을 삭제하면 대화 내용이 모두 사라집니다.\n정말 삭제하시겠어요?")&&(this.closeChat(),this.$axios.delete("/message/"+t.chatId).then(s=>{this.chats.splice(this.chats.findIndex(s=>s.chatId===t.chatId),1),this.$store.dispatch("showSnackbar",{text:"채팅을 삭제하였습니다.",color:"success"})}).catch(t=>{console.log(t.response),this.$store.dispatch("showSnackbar",{text:t.response&&t.response.data.message||"채팅을 삭제하지 못했습니다.",color:"error"})}))},loadPreviousMessages(){(()=>{this.noPreviousMessage||(this.scrollToBottom=!1,this.loadingMessages=!0,this.axios.get("/message",{params:{chatId:this.chatId,timestampBefore:this.messageList[0]?this.$moment(this.messageList[0].data.meta,"YYYY.M.D hh:mm:ss a").format("YMMDDHHmmss"):this.$moment().format("YMMDDHHmmss")},headers:{silent:!0}}).then(t=>{if(Array.isArray(t.data)){t.data.length<15&&(this.noPreviousMessage=!0),t.data.reverse();const s=this.chats.find(t=>t.chatId===this.chatId);this.messageList=t.data.map(t=>({author:t.isSender?"me":s.otherNickName,type:"text",data:{text:t.contents,meta:this.$moment(t.sendTimestamp,"YYYYMMDDHHmmss").format("Y.M.D hh:mm:ss a")}})).concat(this.messageList),this.loadingMessages=!1,this.$nextTick(()=>{this.scrollToBottom=!0})}}).catch(t=>{console.log(t.response),this.scrollToBottom=!0,this.loadingMessages=!1,this.$store.dispatch("showSnackbar",{text:t.response?t.response.data.message:"메시지를 불러오지 못했습니다.",color:"error"})}))})()},loadNewMessages(){(()=>{this.loadingMessages=!0;const t=this.messageList.length>0?this.$moment(this.messageList[this.messageList.length-1].data.meta,"YYYY.M.D hh:mm:ss a").format("YMMDDHHmmss"):void 0;this.axios.get("/message",{params:{chatId:this.chatId,timestampAfter:t},headers:{silent:!0}}).then(s=>{const e=this.chats.find(t=>t.chatId===this.chatId);s.data.reverse(),this.messageList=this.messageList.concat(s.data.filter(s=>!t||s.sendTimestamp>t).map(t=>({author:t.isSender?"me":e.otherNickName,type:"text",data:{text:t.contents,meta:this.$moment(t.sendTimestamp,"YYYYMMDDHHmmss").format("Y.M.D hh:mm:ss a")}}))),this.loadingMessages=!1}).catch(t=>{console.log(t.response),this.loadingMessages=!1,this.$store.dispatch("showSnackbar",{text:t.response?t.response.data.message:"메시지를 불러오지 못했습니다.",color:"error"})})})()},getShortContents(t){return t&&t.length>50?t.substring(0,50)+"...":t}},watch:{pagination:{handler(){this.getChatList()},deep:!0},isChatOpen(t){this.$vuetify.breakpoint.xsOnly&&(document.body.style.position=t?"fixed":"initial")}}},m=r,c=e("0c7c"),l=Object(c["a"])(m,a,i,!1,null,null,null);s["default"]=l.exports}}]);
//# sourceMappingURL=chunk-2d0e9752.c8efe41a.js.map