<template>
  <v-container :class="{'pa-3':$vuetify.breakpoint.xsOnly}">
    <div class="mx-auto mb-5" style="width:50%">
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1650 512" style="enable-background:new 0 0 1650 512;" xml:space="preserve">
        <path class="st1" d="M698.2,240.1c0-17.4-14.1-31.6-31.6-31.6c-17.4,0-31.6,14.1-31.6,31.6c0,17.4,14.1,31.6,31.6,31.6 C684.1,271.6,698.2,257.5,698.2,240.1"/>
        <path class="st1" d="M962.2,240.1c0-17.4-14.1-31.6-31.6-31.6c-17.4,0-31.6,14.1-31.6,31.6c0,17.4,14.1,31.6,31.6,31.6 C948,271.6,962.2,257.5,962.2,240.1"/>
        <g>
          <path class="st2" d="M1004,112.5L1004,112.5c-16.4,0-30.1,11.9-32.7,27.6c-17.1-10-37-15.8-58.3-15.8c-52.5,0-96.8,35-111,82.9
            h-37.2V72.8c0-21.3-17.3-38.6-38.6-38.6h0c-21.3,0-38.6,17.3-38.6,38.6v58.2c-12.1-4.3-25-6.6-38.6-6.6
            c-63.9,0-115.7,51.8-115.7,115.7c0,63.9,51.8,115.7,115.7,115.7c46.5,0,86.6-27.4,105-67h54c18.4,39.6,58.5,67,105,67
            c22.6,0,43.8-6.5,61.6-17.8c5.6,10.6,16.6,17.8,29.4,17.8h0c18.4,0,33.3-14.9,33.3-33.3V145.7
            C1037.2,127.4,1022.3,112.5,1004,112.5z M649,289.3c-27.2,0-49.2-22-49.2-49.2c0-27.2,22-49.2,49.2-49.2c27.2,0,49.2,22,49.2,49.2
            C698.2,267.3,676.2,289.3,649,289.3z M912.9,289.3c-27.2,0-49.2-22-49.2-49.2c0-27.2,22-49.2,49.2-49.2s49.2,22,49.2,49.2
            C962.2,267.3,940.1,289.3,912.9,289.3z"/>
          <path class="st2" d="M168.1,34.2C104.2,34.2,52.4,86,52.4,149.9l0,0v172.6c0,18.4,14.9,33.3,33.3,33.3h0
            c18.4,0,33.3-14.9,33.3-33.3v-67.9c14.9,7,31.6,11,49.2,11c63.9,0,115.7-51.8,115.7-115.7S232,34.2,168.1,34.2z M168.1,199.2
            c-27.2,0-49.2-22-49.2-49.2s22-49.2,49.2-49.2c27.2,0,49.2,22,49.2,49.2S195.3,199.2,168.1,199.2z"/>
          <path class="st2" d="M1264.7,112.5c-15,0-27.6,9.9-31.8,23.5c-15.3-7.5-32.5-11.7-50.7-11.7c-63.9,0-115.7,51.8-115.7,115.7
            c0,63.9,51.8,115.7,115.7,115.7c17.6,0,34.3-3.9,49.2-11v31.4c0,27.2-22,49.2-49.2,49.2c-20.3,0-37.8-12.3-45.3-29.9
            c-5.1-11.9-17.2-19.3-30.2-19.3c-24.1,0-40.1,24.8-30.4,46.9c18,40.6,58.6,68.8,105.8,68.8c62,0,112.6-48.7,115.6-110h0.1V145.7
            C1298,127.4,1283.1,112.5,1264.7,112.5z M1182.3,289.3c-27.2,0-49.2-22-49.2-49.2c0-27.2,22-49.2,49.2-49.2s49.2,22,49.2,49.2
            C1231.5,267.3,1209.4,289.3,1182.3,289.3z"/>
          <path class="st2" d="M1539.8,129.6c-18.4,0-33.3,14.9-33.3,33.3v77.2c0,27.2-22,49.2-49.2,49.2c-27.2,0-49.2-22-49.2-49.2h0v-77.2
            c0-18.4-14.9-33.3-33.3-33.3h0c-18.4,0-33.3,14.9-33.3,33.3v77.2c0,63.9,51.8,115.7,115.7,115.7c17.6,0,34.3-3.9,49.2-11v31.4
            c0,27.2-22,49.2-49.2,49.2c-20.3,0-37.8-12.3-45.3-29.9c-5.1-11.9-17.2-19.3-30.2-19.3c-24.1,0-40.1,24.8-30.4,46.9
            c18,40.6,58.6,68.8,105.8,68.8c62,0,112.6-48.7,115.6-110h0.1v-142v-77.2C1573.1,144.5,1558.2,129.6,1539.8,129.6z"/>
          <path class="st2" d="M514.1,199.3C497.5,153.7,453.6,123,405,123c-64,0-116.1,52.1-116.1,116.1S341,355.2,405,355.2
            c36.5,0,70.1-16.6,92.2-45.6c11.2-14.6,8.4-35.5-6.2-46.7c-14.6-11.2-35.5-8.4-46.7,6.2c-9.5,12.4-23.8,19.5-39.3,19.5
            c-25.6,0-46.7-19.6-49.2-44.5h127c10.9,0,21.1-5.3,27.3-14.2C516.3,220.9,517.8,209.5,514.1,199.3z M404.9,173.8
            c16.2,0,30.3,8.5,38.3,21.2h-76.7C374.6,182.3,388.8,173.8,404.9,173.8z"/>
        </g>
      </svg>
    </div>

    <v-layout>
      <v-flex>
        <v-form ref="form" lazy-validation>
          <v-text-field color="primary" name="userId" ref="userId" height="20" v-model="userId" :error="userIdError" :rules="userIdRules" label="아이디" required maxlength="50" @focus="clearError" autofocus @keydown.enter.stop="focusPassword"></v-text-field>
          <v-text-field color="primary" name="password" ref="password" height="20" v-model="password" :error="passwordError" :rules="passwordRules" label="비밀번호" required type="password" @keydown.enter.stop="signin" @focus="clearError"></v-text-field>

          <v-btn color="primary" round depressed @click="signin" block :loading="loading">로그인</v-btn>
          <v-layout row justify-space-between class="mt-3">
            <v-flex>
              <v-checkbox class="small rememberMe" v-model="rememberMe" label="자동 로그인" color="primary" hide-details onIcon="check_circle" offIcon="radio_button_unchecked"></v-checkbox>
            </v-flex>
            <v-flex text-xs-right>
              <router-link to="/resetPassword" style="color:#12824a">비밀번호 찾기</router-link>
            </v-flex>
          </v-layout>
          <p class="text-xs-center" v-show="message">
            <span class="error--text">{{message}}</span>
          </p>
          <p :class="{'text-xs-center':true, 'mt-3':!message}">
            <component :is="$vuetify.breakpoint.xsOnly?'span':'small'">
              <router-link to="/signup" style="color:#707070">아직 회원이 아니신가요?</router-link>
            </component>
          </p>
        </v-form>
      </v-flex>
    </v-layout>
  </v-container>
</template>

<script>
function getCookie (cname) {
  let name = cname + '=';
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) === 0) {
      return c.substring(name.length, c.length);
    }
  }
  return undefined;
}

function setCookie (name, value, days) {
  let expires = '';
  if (days) {
    let date = new Date();
    date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
    expires = '; expires=' + date.toUTCString();
  }
  document.cookie = name + '=' + (value || '') + expires + '; path=/';
}
export default {
  name: 'Signin',
  data: () => ({
    loading: false,
    message: null,
    userIdError: false,
    passwordError: false,
    userId: '',
    password: '',
    rememberMe: true,
    userIdRules: [v => !!v || '아이디를 입력해주세요.'],
    passwordRules: [v => !!v || '비밀번호를 입력해주세요.']
  }),
  created () {
    if (Object.keys(this.$store.getters.profile).length === 0) {
      this.$axios({
        method: 'POST',
        url: '/refresh',
        headers: { silent: true }
      })
        .then(response => {
          this.loading = false;
          this.$store.dispatch('setUserId', response.data.userId);
          this.$store.dispatch('setToken', true);

          const redirectTo = response.data.redirectTo;
          if (response.data.imminent || response.data.needEmail) {
            this.$store.dispatch('updateAuthInformation', { imminent: response.data.imminent, needEmail: response.data.needEmail });
          }

          if (redirectTo) {
            if (redirectTo === '/auth' && getCookie('authRequirement') && getCookie('authRequirement') >= this.$moment().format('YMMDD')) {
              this.$router.push(decodeURIComponent(window.location.search.replace(new RegExp('^(?:.*[&\\?]' + encodeURIComponent('redirectTo').replace(/[.+*]/g, '\\$&') + '(?:\\=([^&]*))?)?.*$', 'i'), '$1')) || '/');
            } else {
              this.$router.push(redirectTo + window.location.search); // preserve original redirect options
            }
          } else {
            const searchRedirectTo = decodeURIComponent(window.location.search.replace(new RegExp('^(?:.*[&\\?]' + encodeURIComponent('redirectTo').replace(/[.+*]/g, '\\$&') + '(?:\\=([^&]*))?)?.*$', 'i'), '$1'));
            this.$router.push(searchRedirectTo !== '/index' && searchRedirectTo !== '/signin' && searchRedirectTo !== '' ? searchRedirectTo : '/');
          }
        })
        .catch(err => {
          if (getCookie('userId')) {
            this.userId = getCookie('userId');
          }
          if (err.response && err.response.data) {
            if (err.response.data.message !== '로그인 정보가 없습니다.') {
              this.message = err.response.data.message;
            }
          } else {
            this.message = '서버에 접속할 수 없습니다. 인터넷 연결을 확인해주세요.';
          }
          this.$store.dispatch('setToken', false);
        });
    } else {
      if (getCookie('userId')) {
        this.userId = getCookie('userId');
      }
    }
  },

  watch: {
    userId () {
      if (this.userIdError) {
        this.userIdError = false;
      }
      if (this.message) {
        this.message = null;
      }
    },
    password () {
      if (this.passwordError) {
        this.passwordError = false;
      }
      if (this.message) {
        this.message = null;
      }
    }
  },

  methods: {
    clearError () {
      this.$refs.form.resetValidation();
      this.message = null;
    },
    signin () {
      if (this.$refs.form.validate()) {
        if (!this.userId || !this.password || this.userId === '' || this.password === '') {
          this.message = '아이디와 비밀번호를 입력해주세요.';
          return false;
        }
        setCookie('userId', this.userId, 30);
        this.message = null;
        this.userIdError = false;
        this.passwordError = false;
        this.loading = true;
        this.$axios
          .post(
            '/signin',
            {
              userId: this.userId,
              password: this.password,
              rememberMe: this.rememberMe
            },
            { headers: { silent: true } }
          )
          .then(response => {
            this.$store.dispatch('setToken', true);
            this.$store.dispatch('setUserId', this.userId);
            const redirectTo = response.data.redirectTo;
            if (response.data.imminent || response.data.needEmail) {
              this.$store.dispatch('updateAuthInformation', { imminent: response.data.imminent, needEmail: response.data.needEmail });
            }
            if (redirectTo) {
              if (redirectTo === '/auth' && getCookie('authRequirement') && getCookie('authRequirement') >= this.$moment().format('YMMDD')) {
                this.$router.push(decodeURIComponent(window.location.search.replace(new RegExp('^(?:.*[&\\?]' + encodeURIComponent('redirectTo').replace(/[.+*]/g, '\\$&') + '(?:\\=([^&]*))?)?.*$', 'i'), '$1')) || '/');
              } else {
                this.$router.push(redirectTo + window.location.search); // preserve original redirect options
              }
            } else {
              const searchRedirectTo = decodeURIComponent(window.location.search.replace(new RegExp('^(?:.*[&\\?]' + encodeURIComponent('redirectTo').replace(/[.+*]/g, '\\$&') + '(?:\\=([^&]*))?)?.*$', 'i'), '$1'));
              this.$router.push(searchRedirectTo !== '/index' && searchRedirectTo !== '/signin' && searchRedirectTo !== '' ? searchRedirectTo : '/');
            }
            this.loading = false;
          })
          .catch(err => {
            this.loading = false;
            if (err.response && err.response.data) {
              if (err.response.data.target && this.$refs[err.response.data.target]) {
                switch (err.response.data.target) {
                  case 'userId':
                    this.userIdError = true;
                    this.$refs.userId.focus();
                    break;
                  case 'password':
                    this.passwordError = true;
                    this.$refs.password.focus();
                    break;
                  default:
                    break;
                }
              }
              this.message = err.response.data.message;
            } else {
              this.message = '서버에 접속할 수 없습니다. 인터넷 연결을 확인해주세요.';
            }
          });
      }
    },
    focusPassword () {
      if (this.password !== '') {
        this.signin();
      } else {
        this.$refs.password.focus();
      }
    }
  }
};
</script>

<style>
.rememberMe.v-input--checkbox .v-label.theme--light{
  color:#12824a;
}
.small i.v-icon {
  font-size: 18px;
}
.small label {
  font-size: 15px;
}
.small.v-input--checkbox {
  margin-top: 0;
  padding-top: 0;
}
.small .v-input--selection-controls__input {
  width: 16px;
  height: 16px;
  margin-right: 4px;
}
</style>
